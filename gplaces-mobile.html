<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Restaurant Finder - Mobile</title>
  <style>
    /* General resets */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f9fafc;
      color: #333;
      overflow-x: hidden;
    }
    /* Container fills viewport with flex column */
    .mobile-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    /* Mobile Header */
    .mobile-header {
      background: #ffffff;
      padding: 14px 18px;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      z-index: 1000;
      position: relative;
    }
    .header-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      color: #212529;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .header-controls {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    .controls-toggle {
      background: linear-gradient(135deg,#0d6efd,#4dabf7);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 44px;
      transition: background 0.2s ease;
    }
    .controls-toggle:active {
      background: #0b5ed7;
      transform: scale(0.98);
    }
    /* Controls panel */
    .controls-panel {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
      border-radius: 0 0 16px 16px;
      z-index: 999;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .controls-panel.expanded {
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .controls-content {
      padding: 18px;
    }
    /* Form groups */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 14px;
      color: #333;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      border: 1px solid #dcdfe3;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 15px;
      background: #fff;
      transition: border-color 0.2s ease;
      min-height: 48px;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.1);
    }
    .coords-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    input[type="range"] {
      width: 100%;
      margin: 8px 0;
    }
    /* Buttons */
    .btn {
      border-radius: 10px;
      font-size: 15px;
      padding: 14px 18px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      user-select: none;
      -webkit-user-select: none;
      transition: all 0.2s ease;
      min-height: 48px;
    }
    .btn:active:not(:disabled) {
      transform: scale(0.98);
    }
    .btn-primary {
      background: linear-gradient(135deg,#0d6efd,#4dabf7);
      color: white;
    }
    .btn-primary:active {
      background: #0b5ed7;
    }
    .btn-secondary {
      background: #adb5bd;
      color: #212529;
    }
    .btn-secondary:active {
      background: #868e96;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:active {
      background: #bb2d3b;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    .btn-row .btn {
      flex: 1;
      min-width: 120px;
    }
    /* Toggle switches */
    .toggle-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 16px 0;
    }
    .toggle-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
    }
    .toggle-item label {
      font-size: 15px;
      font-weight: 500;
      margin: 0;
    }
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
      background: #d1d5db;
      border-radius: 14px;
      transition: background 0.2s ease;
      cursor: pointer;
    }
    .toggle-switch::before {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 12px;
      background: white;
      top: 2px;
      left: 2px;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle-switch.active {
      background: #0d6efd;
    }
    .toggle-switch.active::before {
      transform: translateX(22px);
    }
    /* Map container: fills remaining height in flex */
    .map-container {
      flex: 1 1 auto;
      min-height: 300px;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 300px;
    }
    /* Bottom sheet fixed footer */
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
      transform: translateY(calc(100% - 70px));
      transition: transform 0.3s ease-in-out;
      max-height: 65vh;
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }
    .bottom-sheet.expanded {
      transform: translateY(0);
    }
    .sheet-handle {
      width: 60px;
      height: 6px;
      background: #d1d5db;
      border-radius: 3px;
      margin: 10px auto;
      cursor: grab;
    }
    .sheet-header {
      padding: 10px 20px;
      border-bottom: 1px solid #f1f3f6;
      user-select: none;
    }
    .sheet-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sheet-content {
      padding: 14px 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: #e9ecef;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0d6efd, #00b4d8);
      transition: width 0.3s ease;
      width: 0%;
    }
    .status {
      margin-top: 6px;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f8f9fa;
      color: #495057;
      text-align: center;
    }
    .stats-grid {
      display: flex;
      gap: 12px;
      margin: 16px 0;
    }
    .stat-card {
      flex: 1;
      background: #ffffff;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      user-select: none;
    }
    .stat-number {
      font-size: 22px;
      font-weight: 700;
      color: #212529;
      margin: 0;
    }
    .stat-label {
      font-size: 12px;
      color: #6c757d;
      margin-top: 4px;
      user-select: none;
    }
    .results-header {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 15px;
      color: #212529;
      user-select: none;
    }
    #results {
      list-style: none;
      padding-left: 0;
      margin: 0;
      flex: 1;
      overflow-y: auto;
    }
    #results li {
      background: #fff;
      border-radius: 10px;
      border: 1px solid #f1f3f6;
      margin-bottom: 10px;
      padding: 12px 14px;
      cursor: pointer;
      transition: box-shadow 0.2s ease, transform 0.1s ease;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #results li:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #results li.selected {
      border-color: #0d6efd;
      background: #e7f1ff;
    }
    .result-name {
      font-size: 15px;
      font-weight: 600;
      color: #212529;
      margin: 0;
    }
    .result-rating {
      font-size: 13px;
      color: #495057;
      margin: 0;
    }
    .result-hint {
      font-size: 11px;
      color: #868e96;
      font-style: italic;
      margin: 0;
    }
    @media (min-width: 768px) {
      .mobile-container {
        flex-direction: row;
      }
      .mobile-header {
        width: 350px;
        height: 100vh;
        border-right: 1px solid #e5e7eb;
        border-bottom: none;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .controls-toggle {
        display: none;
      }
      .controls-panel {
        position: static;
        max-height: none;
        overflow: visible;
        box-shadow: none;
        border-bottom: none;
        border-radius: 0;
      }
      .controls-panel.expanded {
        max-height: none;
      }
      .map-container {
        flex: 1;
      }
      .bottom-sheet {
        position: static;
        transform: none;
        max-height: none;
        border-radius: 0;
        box-shadow: none;
        background: transparent;
        flex-direction: row;
        padding: 0;
      }
      .bottom-sheet.expanded {
        transform: none;
      }
      .sheet-handle {
        display: none;
      }
      .sheet-header {
        cursor: default;
        border-bottom: none;
        padding: 12px 20px;
        flex: 0 0 auto;
      }
      .sheet-content {
        max-height: none;
        padding: 0 20px 20px 20px;
        flex: 1 1 auto;
        overflow: auto;
        display: block;
      }
    }
    .btn.loading {
      pointer-events: none;
      position: relative;
      color: transparent;
    }
    .btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
    }
    @keyframes spin {
      to {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <!-- Mobile Header with Controls -->
    <div class="mobile-header">
      <h1 class="header-title">
        <span>🍽️</span>
        Restaurant Finder
      </h1>
      
      <div class="header-controls">
        <button class="controls-toggle" id="controlsToggle">
          <span>⚙️</span>
          <span id="toggleText">Settings</span>
        </button>
      </div>
      <!-- Collapsible Controls Panel -->
      <div class="controls-panel" id="controlsPanel">
        <div class="controls-content">
          <!-- Location Controls -->
          <div class="form-group">
            <label>📍 Search Center</label>
            <div class="coords-row">
              <input type="number" id="centerLat" step="0.001" placeholder="Latitude" value="44.437" />
              <input type="number" id="centerLng" step="0.001" placeholder="Longitude" value="26.097" />
            </div>
            <button type="button" class="btn btn-secondary" id="getCurrentLocation" style="margin-top: 8px; width: 100%;">
              <span>📍</span>
              Use My Location
            </button>
          </div>
          <!-- Search Parameters -->
          <div class="form-group">
            <label>🔍 Search Radius (km)</label>
            <input type="range" id="radiusSlider" min="1" max="20" value="5" />
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
              <span>1km</span>
              <span id="radiusValue">5km</span>
              <span>20km</span>
            </div>
          </div>
          <div class="form-group">
            <label>📏 Cell Size (meters)</label>
            <input type="range" id="cellSlider" min="500" max="3000" step="100" value="1000" />
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
              <span>500m</span>
              <span id="cellValue">1000m</span>
              <span>3000m</span>
            </div>
          </div>
          <!-- Quality Filters -->
          <div class="form-group">
            <label>⭐ Minimum Rating</label>
            <select id="minRating">
              <option value="4.0">4.0+ Stars</option>
              <option value="4.2">4.2+ Stars</option>
              <option value="4.5">4.5+ Stars</option>
              <option value="4.7">4.7+ Stars</option>
              <option value="4.8" selected>4.8+ Stars</option>
              <option value="4.9">4.9+ Stars</option>
            </select>
          </div>
          <div class="form-group">
            <label>💬 Minimum Reviews</label>
            <select id="minReviews">
              <option value="50">50+ Reviews</option>
              <option value="100">100+ Reviews</option>
              <option value="500">500+ Reviews</option>
              <option value="1000" selected>1000+ Reviews</option>
              <option value="2000">2000+ Reviews</option>
            </select>
          </div>
          <!-- Visual Options -->
          <div class="toggle-group">
            <div class="toggle-item">
              <label>Show scan cells</label>
              <div class="toggle-switch" id="showCellsToggle"></div>
            </div>
            <div class="toggle-item">
              <label>Live results</label>
              <div class="toggle-switch active" id="showProgressToggle"></div>
            </div>
          </div>
          <!-- Action Buttons -->
          <div class="btn-row">
            <button type="button" class="btn btn-primary" id="startSearch">
              <span>🔍</span>
              Start Search
            </button>
            <button type="button" class="btn btn-danger" id="cancelSearch" disabled>
              <span>⏹️</span>
              Cancel
            </button>
          </div>
          
          <button type="button" class="btn btn-secondary" id="clearResults" style="width: 100%;">
            <span>🗑️</span>
            Clear Results
          </button>
        </div>
      </div>
    </div>
    <!-- Map Container -->
    <div class="map-container">
      <div id="map"></div>
    </div>
    <!-- Bottom Sheet for Results (Mobile) -->
    <div class="bottom-sheet" id="bottomSheet">
      <div class="sheet-handle"></div>
      
      <div class="sheet-header" id="sheetHeader">
        <h3 class="sheet-title">
          <span>📊 Results</span>
          <span id="sheetToggleIcon">▲</span>
        </h3>
      </div>
      <div class="sheet-content">
        <!-- Progress Section -->
        <div class="progress-section">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="status" id="status">Ready to search...</div>
        </div>
        <!-- Statistics -->
        <div class="stats-grid">
          <div class="stat-card">
            <p class="stat-number" id="totalCount">0</p>
            <p class="stat-label">Found</p>
          </div>
          <div class="stat-card">
            <p class="stat-number" id="filteredCount">0</p>
            <p class="stat-label">Filtered</p>
          </div>
          <div class="stat-card">
            <p class="stat-number" id="cellsScanned">0</p>
            <p class="stat-label">Cells</p>
          </div>
        </div>
        <!-- Results -->
        <div class="results-container">
          <div class="results-header">🍽️ Restaurants</div>
          <ul id="results"></ul>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Configuration & global variables omitted for brevity; same as your original code...
    const CONFIG = { API_KEY: 'AIzaSyD0yHf3IW0QT2Rsu69esI_PzP0KXZLhksg' };
    let map, info, svc;
    let searchCancelled = false;
    let currentMarkers = [];
    let cellOverlays = [];
    let currentCellOverlay = null;
    let searchResults = new Map();
    let currentCellIndex = -1;
    let selectedMarker = null;
    let lastClickedPlace = null;
    let lastClickTime = 0;
    let isSearching = false;
    // UI state
    let controlsPanelExpanded = false;
    let bottomSheetExpanded = false;
    // Utility functions (same as your original code)
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const toRad = (x) => x * Math.PI / 180;
    function haversine(a, b) {
      const R = 6371000;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const s1 = toRad(a.lat);
      const s2 = toRad(b.lat);
      const A = Math.sin(dLat / 2) ** 2 + Math.cos(s1) * Math.cos(s2) * Math.sin(dLng / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(A));
    }
    // Your existing functions (toggleControlsPanel, toggleBottomSheet, setupToggleSwitches, updateSliderValues, createMarkerIcon, selectMarker, generateGoogleMapsUrl,
    // handlePlaceClick, createCellOverlay, updateCurrentCell, clearVisualElements, toggleCellVisibility, nearbyAll, textAll, processPartialResults,
    // addResultsToMap, updateResultsList, updateStats, buildGridCenters, scanArea, updateStatus, updateProgress, getCurrentLocation, initMap)
    // remain unchanged from your original code, except toggleBottomSheet no longer toggles class instantly due to swipe gestures now.
    // Modified toggleBottomSheet to sync with swipe gestures:
    function toggleBottomSheet() {
      const sheet = document.getElementById('bottomSheet');
      const icon = document.getElementById('sheetToggleIcon');
      
      bottomSheetExpanded = !bottomSheetExpanded;
      
      if (bottomSheetExpanded) {
        sheet.classList.add('expanded');
        icon.textContent = '▼';
        sheet.style.transform = `translateY(0)`;
        currentY = 0;
      } else {
        sheet.classList.remove('expanded');
        icon.textContent = '▲';
        sheet.style.transform = `translateY(calc(100% - 70px))`;
        currentY = window.innerHeight - 70;
      }
    }
    // Other initialization...
    function toggleControlsPanel() {
      const panel = document.getElementById('controlsPanel');
      const toggle = document.getElementById('controlsToggle');
      const toggleText = document.getElementById('toggleText');
      
      controlsPanelExpanded = !controlsPanelExpanded;
      
      if (controlsPanelExpanded) {
        panel.classList.add('expanded');
        toggleText.textContent = 'Close';
        toggle.innerHTML = '<span>✖️</span><span>Close</span>';
      } else {
        panel.classList.remove('expanded');
        toggleText.textContent = 'Settings';
        toggle.innerHTML = '<span>⚙️</span><span>Settings</span>';
      }
    }
    // Setup event listeners for UI controls
    function setupUIEventListeners() {
      document.getElementById('controlsToggle').addEventListener('click', toggleControlsPanel);
      document.getElementById('sheetHeader').addEventListener('click', toggleBottomSheet);
      document.getElementById('startSearch').addEventListener('click', scanArea);
      document.getElementById('cancelSearch').addEventListener('click', () => {
        searchCancelled = true;
        updateStatus('🛑 Cancelling search...');
      });
      document.getElementById('clearResults').addEventListener('click', clearVisualElements);
      document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);
      setupToggleSwitches();
      updateSliderValues();
    }
    // Swipe gesture code for bottom sheet
    (function() {
      const sheet = document.getElementById('bottomSheet');
      const handle = document.querySelector('.sheet-handle');
      let startY = 0;
      let currentY = 0;
      let dragging = false;
      const windowHeight = window.innerHeight;
      const collapsedHeight = windowHeight - 70;
      const expandedHeight = windowHeight * 0.35; // 65% expanded means 35% from top
      function setTranslateY(y) {
        if (y < expandedHeight) y = expandedHeight;
        if (y > collapsedHeight) y = collapsedHeight;
        sheet.style.transition = 'none';
        sheet.style.transform = `translateY(${y}px)`;
        currentY = y;
      }
      function onStart(evt) {
        dragging = true;
        startY = evt.touches ? evt.touches[0].clientY : evt.clientY;
        sheet.style.transition = 'none';
      }
      function onMove(evt) {
        if (!dragging) return;
        const currentTouchY = evt.touches ? evt.touches[0].clientY : evt.clientY;
        const diff = currentTouchY - startY;
        let newY = currentY + diff;
        if (newY < expandedHeight) newY = expandedHeight;
        if (newY > collapsedHeight) newY = collapsedHeight;
        sheet.style.transform = `translateY(${newY}px)`;
      }
      function onEnd(evt) {
        if (!dragging) return;
        dragging = false;
        const endY = evt.changedTouches ? evt.changedTouches[0].clientY : evt.clientY;
        const diff = endY - startY;
        sheet.style.transition = 'transform 0.3s ease';
        const midway = (collapsedHeight + expandedHeight) / 2;
        if (currentY + diff > midway) {
          // Collapse
          sheet.style.transform = `translateY(${collapsedHeight}px)`;
          bottomSheetExpanded = false;
          document.getElementById('sheetToggleIcon').textContent = '▲';
          sheet.classList.remove('expanded');
        } else {
          // Expand
          sheet.style.transform = `translateY(${expandedHeight}px)`;
          bottomSheetExpanded = true;
          document.getElementById('sheetToggleIcon').textContent = '▼';
          sheet.classList.add('expanded');
        }
        currentY = parseFloat(sheet.style.transform.replace(/[^0-9.-]/g, '')) || collapsedHeight;
      }
      window.addEventListener('load', () => {
        currentY = collapsedHeight;
        sheet.style.transform = `translateY(${currentY}px)`;
      });
      handle.addEventListener('touchstart', onStart);
      handle.addEventListener('touchmove', onMove);
      handle.addEventListener('touchend', onEnd);
      handle.addEventListener('mousedown', onStart);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onEnd);
      // Prevent scrolling page when dragging handle on touch devices
      handle.addEventListener('touchmove', evt => evt.preventDefault(), { passive: false });
    })();
    // Initialize map and UI
    function initMap() {
      const center = { lat: 44.437, lng: 26.097 };
      map = new google.maps.Map(document.getElementById("map"), {
        center: center,
        zoom: 12,
        disableDefaultUI: false,
        zoomControl: true,
        mapTypeControl: false,
        scaleControl: false,
        streetViewControl: false,
        rotateControl: false,
        fullscreenControl: false,
        gestureHandling: 'greedy'
      });
      info = new google.maps.InfoWindow();
      svc = new google.maps.places.PlacesService(map);
      setupUIEventListeners();
      // Handle window resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          google.maps.event.trigger(map, 'resize');
          if (window.innerWidth >= 768) {
            if (controlsPanelExpanded) {
              controlsPanelExpanded = false;
              document.getElementById('controlsPanel').classList.remove('expanded');
            }
            if (bottomSheetExpanded) {
              bottomSheetExpanded = false;
              document.getElementById('bottomSheet').classList.remove('expanded');
            }
          }
        }, 250);
      });
      updateStatus('🎯 Ready to search. Configure parameters and tap Start Search.');
      updateStats();
    }
    window.initMap = initMap;
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD0yHf3IW0QT2Rsu69esI_PzP0KXZLhksg&libraries=places&callback=initMap"></script>
</body>
</html>
